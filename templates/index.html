<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stable Object Detection</title>

<style>
body {
    font-family: Arial;
    background: #f4f9fb;
    text-align: center;
}
button {
    padding: 12px 25px;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
}
.container {
    display: flex;
    justify-content: center;
    gap: 30px;
}
video, canvas {
    width: 320px;
    height: 240px;
    border-radius: 10px;
}
#info {
    margin-top: 20px;
    font-size: 18px;
}
</style>
</head>

<body>

<h1>Real-Time Object Detection (NO Flicker)</h1>

<button onclick="startDetection()">Start</button>
<button onclick="stopDetection()">Stop</button>

<div class="container">
    <video id="video" autoplay muted></video>
    <canvas id="canvas"></canvas>
</div>

<div id="info">No objects detected</div>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let interval;

navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => video.srcObject = stream);

function startDetection() {
    interval = setInterval(sendFrame, 500);
}

function stopDetection() {
    clearInterval(interval);
}

function sendFrame() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(async blob => {
        let fd = new FormData();
        fd.append("image", blob);

        let res = await fetch("/detect", {
            method: "POST",
            body: fd
        });

        let data = await res.json();

        ctx.drawImage(video, 0, 0);

        data.objects.forEach(obj => {
            let [x1, y1, x2, y2] = obj.box;
            ctx.strokeStyle = "lime";
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
            ctx.fillStyle = "lime";
            ctx.fillText(`${obj.label} #${obj.id}`, x1, y1 - 5);
        });

        let info = "";
        for (let key in data.counts) {
            info += `<b>${key}</b>: ${data.counts[key]}<br>`;
        }
        document.getElementById("info").innerHTML =
            info || "No objects detected";
    }, "image/jpeg");
}
</script>

</body>
</html>
