<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YOLOv8 Real-Time Detection</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ---------- Global Styles ---------- */
body { 
    font-family:'Roboto', sans-serif; 
    background: linear-gradient(to right,#e0eafc,#cfdef3); 
    text-align:center; margin:0; padding:0; color:#333;
}
h1 { 
    margin:20px 0; font-size:2.5em; font-weight:700; 
    color:#1b3a57; text-shadow:1px 1px 2px rgba(0,0,0,0.2); 
}

/* ---------- Buttons ---------- */
.btn { 
    padding:12px 25px; font-size:16px; margin:10px; 
    border:none; border-radius:8px; cursor:pointer; 
    box-shadow:0 4px 8px rgba(0,0,0,0.2); font-weight:500; 
    transition:0.3s;
}
.btn.start { background:#4CAF50; color:white; }
.btn.start:hover { background:#45a049; }
.btn.stop { background:#f44336; color:white; }
.btn.stop:hover { background:#d32f2f; }

/* ---------- Layout ---------- */
.container { 
    display:flex; justify-content:center; gap:30px; 
    margin-top:20px; flex-wrap:wrap;
}
.video-card { 
    background:#fff; border-radius:12px; padding:15px; 
    box-shadow:0 6px 15px rgba(0,0,0,0.2); flex:1 1 300px;
}
.video-card h3 { 
    margin-top:0; font-size:1.2em; font-weight:500; color:#1b3a57;
}
canvas { 
    border-radius:8px; width:100%; max-width:640px; height:auto; 
    border:2px solid #1b3a57; box-shadow:0 4px 10px rgba(0,0,0,0.3);
}

/* ---------- Counts Table ---------- */
#counts { 
    margin:30px auto; background:#fff; padding:20px; 
    border-radius:12px; width:fit-content; 
    box-shadow:0 6px 15px rgba(0,0,0,0.2); text-align:left;
}
#counts h3 { margin-top:0;color:#1b3a57; font-weight:500; }
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:left; }
th { background:#1b3a57; color:white; }
tr:nth-child(even){ background:#f9f9f9; }
tr:hover { background:#f1f1f1; }
</style>
</head>
<body>

<h1>YOLOv8 Real-Time Object Detection</h1>
<div>
    <button class="btn start" onclick="startDetection()">Start Detection</button>
    <button class="btn stop" onclick="stopDetection()">Stop Detection</button>
</div>

<div class="container">
    <div class="video-card">
        <h3>Camera Input</h3>
        <canvas id="inputCanvas" width="640" height="480"></canvas>
    </div>
    <div class="video-card">
        <h3>Detection Output</h3>
        <canvas id="outputCanvas" width="640" height="480"></canvas>
    </div>
</div>

<div id="counts">
    <h3>Object Counts</h3>
    <table id="countTable">
        <thead>
            <tr><th>Object</th><th>Count</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<video id="video" autoplay muted playsinline style="display:none"></video>

<script>
const video = document.getElementById("video");
const inputCanvas = document.getElementById("inputCanvas");
const outputCanvas = document.getElementById("outputCanvas");
const inCtx = inputCanvas.getContext("2d");
const outCtx = outputCanvas.getContext("2d");
const countTableBody = document.querySelector("#countTable tbody");

let stream, predictions=[], detecting=false;

// ---------- Start ----------
async function startDetection(){
    try {
        stream = await navigator.mediaDevices.getUserMedia({video:true});
        video.srcObject = stream;
        detecting=true;
        loop();
    } catch(err){ alert("Webcam not available: "+err); }
}

// ---------- Stop ----------
function stopDetection(){
    detecting=false;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    predictions=[];
    inCtx.clearRect(0,0,inputCanvas.width,inputCanvas.height);
    outCtx.clearRect(0,0,outputCanvas.width,outputCanvas.height);
    countTableBody.innerHTML='';
}

// ---------- Main Loop ----------
async function loop(){
    if(!detecting) return;

    inCtx.drawImage(video,0,0,inputCanvas.width,inputCanvas.height);

    inputCanvas.toBlob(async blob=>{
        const fd=new FormData();
        fd.append("image",blob);
        try{
            const res = await fetch("/detect",{method:"POST",body:fd});
            const data = await res.json();
            predictions = data.objects || [];

            // Pixel to cm conversion
            predictions.forEach(obj=>{
                obj.width_cm = (obj.width_px * 0.1).toFixed(1);
                obj.height_cm = (obj.height_px * 0.1).toFixed(1);
            });

            updateCounts(predictions);
        }catch(err){ console.error(err); }
    });

    outCtx.drawImage(video,0,0,outputCanvas.width,outputCanvas.height);
    drawBoxes(predictions);

    requestAnimationFrame(loop);
}

// ---------- Draw Boxes with Color Coding ----------
function drawBoxes(objects){
    objects.forEach(obj=>{
        let [x1,y1,x2,y2] = obj.box;
        const scaleX = outputCanvas.width / obj.image_width;
        const scaleY = outputCanvas.height / obj.image_height;
        x1*=scaleX; x2*=scaleX; y1*=scaleY; y2*=scaleY;
        const boxWidth = x2-x1;
        const boxHeight = y2-y1;

        // Color coding
        let color = "green"; // default
        const personClasses = ["person"];
        const vehicleClasses = ["bicycle","car","motorcycle","bus","truck","train","boat"];
        const animalClasses = ["bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe"];

        if(personClasses.includes(obj.label)) color = "red";
        else if(vehicleClasses.includes(obj.label)) color = "blue";
        else if(animalClasses.includes(obj.label)) color = "orange";

        // Draw box
        outCtx.strokeStyle=color;
        outCtx.lineWidth=2;
        outCtx.strokeRect(x1,y1,boxWidth,boxHeight);

        // Label + confidence
        outCtx.fillStyle=color;
        outCtx.font="16px Roboto";
        outCtx.fillText(`${obj.label} ${obj.confidence.toFixed(2)}`,x1,y1-20);

        // Dimensions in cm
        outCtx.fillStyle="cyan";
        outCtx.fillText(`${obj.width_cm} Ã— ${obj.height_cm} cm`, x1, y2+18);
    });
}

// ---------- Update Counts ----------
function updateCounts(objects){
    countTableBody.innerHTML='';
    const counts={};
    objects.forEach(o=>counts[o.label]=(counts[o.label]||0)+1);
    for(const [label,count] of Object.entries(counts)){
        const row=document.createElement('tr');
        row.innerHTML=`<td>${label}</td><td>${count}</td>`;
        countTableBody.appendChild(row);
    }
}
</script>

</body>
</html>
