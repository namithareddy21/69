<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 Real-time Object Detection</title>
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        #container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
        }

        #video-container {
            position: relative;
        }

        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #controls {
            text-align: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: 0.3s;
        }

        button:hover { opacity: 0.85; }
        button.stop { background: #f44336; }

        #counts {
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 200px;
            height: fit-content;
        }

        #counts h3 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: #4CAF50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 6px 10px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 14px;
        }

        th {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>

    <h1>YOLOv8 Real-time Object Detection</h1>

    <div id="controls">
        <button id="start-btn">Start Detection</button>
        <button id="stop-btn" class="stop" disabled>Stop Detection</button>
    </div>

    <div id="container">
        <div id="video-container">
            <video id="video" autoplay muted playsinline style="display:none;"></video>
            <canvas id="outputCanvas"></canvas>
        </div>

        <div id="counts">
            <h3>Object Counts</h3>
            <table id="countTable">
                <thead>
                    <tr><th>Object</th><th>Count</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const outputCanvas = document.getElementById("outputCanvas");
        const outCtx = outputCanvas.getContext("2d");
        const startBtn = document.getElementById("start-btn");
        const stopBtn = document.getElementById("stop-btn");
        const countTableBody = document.querySelector("#countTable tbody");

        let stream, predictions = [], detecting = false;

        async function startDetection() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;

                video.addEventListener("loadedmetadata", () => {
                    outputCanvas.width = video.videoWidth;
                    outputCanvas.height = video.videoHeight;
                    video.play();
                    detecting = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    loop();
                });

            } catch (err) {
                alert("Webcam not available: " + err);
                console.error(err);
            }
        }

        function stopDetection() {
            detecting = false;
            if (stream) stream.getTracks().forEach(track => track.stop());
            predictions = [];
            outCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            countTableBody.innerHTML = '';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        async function loop() {
            if (!detecting) return;

            if(video.readyState >= 2){
                outCtx.drawImage(video, 0, 0, outputCanvas.width, outputCanvas.height);

                // Send frame every loop
                outputCanvas.toBlob(async blob => {
                    const fd = new FormData();
                    fd.append("image", blob);

                    try {
                        const res = await fetch("/detect", { method: "POST", body: fd });
                        const data = await res.json();
                        predictions = data.objects || [];

                        predictions.forEach(obj => {
                            obj.width_cm = (obj.width_px * 0.1).toFixed(1);
                            obj.height_cm = (obj.height_px * 0.1).toFixed(1);
                        });

                        updateCounts(predictions);
                        drawBoxes(predictions);

                    } catch (err) {
                        console.error("Detection error:", err);
                    }
                }, "image/jpeg");
            }

            requestAnimationFrame(loop);
        }

        function drawBoxes(objects) {
            objects.forEach(obj => {
                let [x1, y1, x2, y2] = obj.box;
                const scaleX = outputCanvas.width / obj.image_width;
                const scaleY = outputCanvas.height / obj.image_height;
                x1 *= scaleX; x2 *= scaleX; y1 *= scaleY; y2 *= scaleY;
                const boxWidth = x2 - x1;
                const boxHeight = y2 - y1;

                let color = "green";
                const personClasses = ["person"];
                const vehicleClasses = ["bicycle","car","motorcycle","bus","truck","train","boat"];
                const animalClasses = ["bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe"];

                if (personClasses.includes(obj.label)) color = "red";
                else if (vehicleClasses.includes(obj.label)) color = "blue";
                else if (animalClasses.includes(obj.label)) color = "orange";

                // Draw box
                outCtx.strokeStyle = color;
                outCtx.lineWidth = 2;
                outCtx.strokeRect(x1, y1, boxWidth, boxHeight);

                // Draw label
                outCtx.fillStyle = color;
                outCtx.font = "16px Roboto";
                outCtx.fillText(`${obj.label} ${obj.confidence.toFixed(2)}`, x1, y1 - 20);

                // Dimensions
                outCtx.fillStyle = "cyan";
                outCtx.fillText(`${obj.width_cm} Ã— ${obj.height_cm} cm`, x1, y2 + 18);
            });
        }

        function updateCounts(objects) {
            countTableBody.innerHTML = '';
            const counts = {};
            objects.forEach(o => counts[o.label] = (counts[o.label] || 0) + 1);
            for (const [label, count] of Object.entries(counts)) {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${label}</td><td>${count}</td>`;
                countTableBody.appendChild(row);
            }
        }

        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
    </script>

</body>
</html>
