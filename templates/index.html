<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Stable Object Detection</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f9fb; text-align: center; }
        h1 { margin: 20px; }
        button { padding: 12px 25px; border: none; background: #6ec7a1; color: white; font-size: 16px; border-radius: 20px; cursor: pointer; margin: 10px; }
        .container { display: flex; justify-content: center; gap: 40px; margin-top: 20px; }
        .box { background: white; padding: 15px; border-radius: 15px; }
        video, canvas { width: 320px; height: 240px; border-radius: 10px; }
        .info { margin-top: 30px; font-size: 18px; }
        #count { background: #e8f5e8; padding: 15px; border-radius: 10px; margin: 10px 0; min-height: 100px; text-align: left; max-width: 400px; margin: 20px auto; }
        .status { font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <h1>üñºÔ∏è STABLE OBJECT DETECTION</h1>
    <button onclick="startDetection()">‚ñ∂Ô∏è Start Detection</button>
    <button onclick="stopDetection()">‚èπÔ∏è Stop</button>
    <div class="status" id="status">Ready</div>
    
    <div class="container">
        <div class="box">
            <h3>üìπ Live Camera</h3>
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="box">
            <h3>üéØ Detection (Stable Boxes)</h3>
            <canvas id="canvas"></canvas>
        </div>
    </div>
    
    <div class="info">
        <div><b>üìä Counts by Class:</b></div>
        <div id="count">No objects detected</div>
        <div id="desc" class="status"></div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let interval = null;
        let tracks = {};
        let trackIdCounter = 0;
        const MAX_AGE = 45;
        const IOU_THRESH = 0.3;

        navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480, facingMode: 'environment' } 
        }).then(stream => {
            video.srcObject = stream;
            document.getElementById('status').textContent = 'Camera ready';
        }).catch(e => {
            document.getElementById('status').textContent = 'Camera access denied';
        });

        function iou(boxA, boxB) {
            const [ax1, ay1, ax2, ay2] = boxA;
            const [bx1, by1, bx2, by2] = boxB;
            const x1 = Math.max(ax1, bx1);
            const y1 = Math.max(ay1, by1);
            const x2 = Math.min(ax2, bx2);
            const y2 = Math.min(ay2, by2);
            const inter = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const areaA = (ax2 - ax1) * (ay2 - ay1);
            const areaB = (bx2 - bx1) * (by2 - by1);
            return inter / (areaA + areaB - inter + 1e-6);
        }

        function updateTracks(currObjects) {
            let matched = [];
            let used = new Set();
            
            // Update existing
            for (let trackId in tracks) {
                let track = tracks[trackId];
                track.age++;
                let bestIou = 0;
                let bestIdx = -1;
                
                for (let i = 0; i < currObjects.length; i++) {
                    if (used.has(i)) continue;
                    let iouVal = iou(track.box, currObjects[i].box);
                    if (iouVal > IOU_THRESH && iouVal > bestIou) {
                        bestIou = iouVal;
                        bestIdx = i;
                    }
                }
                
                if (bestIdx !== -1) {
                    let obj = currObjects[bestIdx];
                    // Smooth position (0.8 previous + 0.2 new)
                    let [tx1, ty1, tx2, ty2] = track.box;
                    let [ox1, oy1, ox2, oy2] = obj.box;
                    track.box = [
                        0.8 * tx1 + 0.2 * ox1,
                        0.8 * ty1 + 0.2 * oy1,
                        0.8 * tx2 + 0.2 * ox2,
                        0.8 * ty2 + 0.2 * oy2
                    ];
                    track.age = 0;
                    track.hits = (track.hits || 0) + 1;
                    
                    matched.push({
                        ...obj,
                        box: track.box,
                        trackId,
                        stable: true,
                        age: track.hits
                    });
                    used.add(bestIdx);
                }
            }
            
            // New tracks
            for (let i = 0; i < currObjects.length; i++) {
                if (used.has(i)) continue;
                let newId = trackIdCounter++;
                tracks[newId] = {
                    box: currObjects[i].box,
                    age: 0,
                    hits: 1
                };
                matched.push({
                    ...currObjects[i],
                    trackId: newId,
                    stable: false,
                    age: 1
                });
            }
            
            // Cleanup
            Object.keys(tracks).forEach(id => {
                if (tracks[id].age > MAX_AGE) delete tracks[id];
            });
            
            return matched.filter(obj => obj.stable || obj.age <= 3);
        }

        function startDetection() {
            if (interval) return;
            interval = setInterval(sendFrame, 100);
            document.getElementById('status').textContent = 'Detecting...';
        }

        function stopDetection() {
            if (interval) clearInterval(interval);
            interval = null;
            tracks = {};
            ctx.drawImage(video, 0, 0);
            document.getElementById('status').textContent = 'Stopped';
        }

        async function sendFrame() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(async blob => {
                const formData = new FormData();
                formData.append('image', blob);
                
                try {
                    const res = await fetch('/detect', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    // Counts
                    let countsHtml = Object.entries(data.class_counts || {})
                        .map(([cls, cnt]) => `<div style="font-weight:bold;color:#2d5a2d;">${cls}: ${cnt}</div>`)
                        .join('');
                    document.getElementById('count').innerHTML = countsHtml || '<div>No objects</div>';
                    document.getElementById('desc').textContent = data.description?.join(', ') || '';
                    
                    // Ultra-stable drawing
                    const stableObjects = updateTracks(data.objects || []);
                    for (let obj of stableObjects) {
                        const [x1, y1, x2, y2] = obj.box;
                        const w = x2 - x1;
                        const h = y2 - y1;
                        
                        // Stable green vs new yellow
                        ctx.strokeStyle = obj.stable ? '#00ff00' : '#ffff00';
                        ctx.lineWidth = obj.stable ? 4 : 2;
                        ctx.strokeRect(x1, y1, w, h);
                        
                        ctx.fillStyle = obj.stable ? '#006600' : '#cc8800';
                        ctx.font = obj.stable ? 'bold 18px Arial' : '16px Arial';
                        ctx.fillText(`${obj.label} ${obj.confidence}`, x1, y1 - 8);
                        
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(`${w.toFixed(0)}x${h.toFixed(0)}px`, x1, y2 + 18);
                        
                        // Track stability indicator
                        if (obj.stable) {
                            ctx.fillStyle = '#00aa00';
                            ctx.fillRect(x1 - 5, y1 - 25, 4, 4);
                        }
                    }
                    
                } catch (e) {
                    console.error(e);
                }
            }, 'image/jpeg', 0.7);
        }
    </script>
</body>
</html>
